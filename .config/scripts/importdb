#!/bin/bash

SQLPATH="$PROJECT_PATH/.jcore/sql"

mkdir -p $SQLPATH
if [ -f $SQLPATH/update.sql.gz ]; then
  gunzip $SQLPATH/update.sql.gz
fi
if [ ! -f $SQLPATH/update.sql ]; then
  EXCLUDE=""
  # Exclude tables from export
  if [ ! -z "$DB_EXCLUDE" ]; then
    ARGS="--exclude_tables="
    for TABLE in $DB_EXCLUDE ; do
      ARGS+="${PREFIX}${TABLE},"
    done
    EXCLUDE=`echo ${ARGS} | sed s/,$//`
  fi
  mkdir -p sql
  echo "Fetching DB from $REMOTEHOST"
  wp db export ${EXCLUDE} --all-tablespaces --single-transaction --quick --lock-tables=false --ssh=$REMOTEHOST --path=$REMOTEPATH - > $SQLPATH/update.sql || rm $SQLPATH/update.sql
fi

if [ -f $SQLPATH/update.sql ]; then
  echo "Found update"
  # Update table prefix
  wp config set --path=$WEBROOT --type=variable table_prefix $WORDPRESS_PREFIX

  wp db reset --path=$WEBROOT --yes
  wp db import --path=$WEBROOT $SQLPATH/update.sql
  if [ -f $SQLPATH/db.sql ]; then
    mv $SQLPATH/db.sql $SQLPATH/db.old.sql
  fi
  mv $SQLPATH/update.sql $SQLPATH/db.sql

  for replaceRecord in $REPLACE; do
    replace=(${replaceRecord//,/ })
    if [[ ${#replace[*]} -ge 2 ]]; then
      echo "Replace ${replace[0]} with ${replace[1]}"
      wp search-replace --path=$WEBROOT "${replace[0]}" "${replace[1]}"  --recurse-objects --report-changed-only --skip-columns=guid
    fi
  done
fi
