#!/bin/bash

if [[ "$PLUGIN_INSTALL" == "composer" ]]; then
  echo "Project set to composer plugins install, skipping plugins."
  exit 0
fi

GITIGNORE="$WEBROOT/wp-content/plugins/.gitignore"

ARGS=()
# shellcheck disable=SC2068
for e in ${PLUGIN_EXCLUDE} ${PLUGIN_GIT} ; do
  echo "$e"
  ARGS+=(--exclude=$e)
done

echo "Syncing plugins"
# shellcheck disable=SC2068
rsync -r --delete --info=progress2 --no-inc-recursive ${REMOTEHOST}:${REMOTEPATH}/wp-content/plugins/ ${WEBROOT}/wp-content/plugins/ ${ARGS[@]}
echo "Plugins synced"

echo "### Autogenerated by jcore-cli, will be overwritten" > ${GITIGNORE}
for PLUGIN in "${PLUGIN_GIT}" ; do
  echo "Including /wp-content/plugins/${PLUGIN} in git"
  echo \!/${PLUGIN}/ >> ${GITIGNORE}
  echo \!/${PLUGIN}/** >> ${GITIGNORE}
done
