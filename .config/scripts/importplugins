#!/bin/bash

TLD="localhost"
PROJECTPATH="/project"
if [[ -f "/vagrant/.config/config-wrapper.sh" ]]; then
  TLD="test"
  PROJECTPATH="/vagrant"
fi
. $PROJECTPATH/.config/config-wrapper.sh

if [[ "$PLUGIN_INSTALL" == "composer" ]]; then
  echo "Project set to composer plugins install, skipping plugins."
  exit 0
fi

GITIGNORE="$WEBROOT/wp-content/plugins/.gitignore"

ARGS=()
for e in ${PLUGIN_EXCLUDE[@]} ${PLUGIN_GIT[@]} ; do
  ARGS+=(--exclude=$e)
done

echo "Syncing plugins"
rsync -r --delete --info=progress2 --no-inc-recursive ${REMOTEHOST}:${REMOTEPATH}/wp-content/plugins/ ${WEBROOT}/wp-content/plugins/ ${ARGS[@]}
echo "Plugins synced"

echo "### Autogenerated by jcore-cli, will be overwritten" > ${GITIGNORE}
for PLUGIN in ${PLUGIN_GIT[@]} ; do
  echo "Including /wp-content/plugins/${PLUGIN} in git"
  echo \!/${PLUGIN}/ >> ${GITIGNORE}
  echo \!/${PLUGIN}/** >> ${GITIGNORE}
done
